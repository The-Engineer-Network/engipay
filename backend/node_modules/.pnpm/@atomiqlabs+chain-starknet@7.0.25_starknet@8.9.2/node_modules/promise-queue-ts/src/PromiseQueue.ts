import {Queue} from "queue-typescript";

type Runner<T = any> = () => Promise<T>;
type RunnerContext<T = any> = {
    runner: Runner<T>,
    resolve: (value: T | PromiseLike<T>) => void,
    reject: (reason?: any) => void
}

export class PromiseQueue {

    queue: Queue<RunnerContext> = new Queue();
    currentPromise: Promise<any> = null;

    private async checkNext() {
        if(this.currentPromise!=null) return;

        while(this.queue.length>0) {
            const context = this.queue.dequeue();
            try {
                this.currentPromise = context.runner();
                context.resolve(await this.currentPromise);
            } catch (error) {
                context.reject(error);
            }
            this.currentPromise = null;
        }
    }

    enqueue<T>(runner: Runner<T>): Promise<T> {
        return new Promise<T>((resolve, reject) => {
            this.queue.enqueue({runner, resolve, reject});
            this.checkNext();
        });
    }

}